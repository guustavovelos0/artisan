# Ralph Progress Log
Started: Sex 16 Jan 2026 00:29:35 -03

## Codebase Patterns
- Prisma 7 requires DATABASE_URL in prisma.config.ts, NOT in schema.prisma
- Use `npm run db:migrate -w @artisan/api` to run migrations (requires Docker PostgreSQL running)
- Generated Prisma client goes to node_modules/@prisma/client
- API runs on port 3001, Web will run on port 5173
- Pages go in apps/web/src/pages/ directory
- Use react-hook-form + zod for form validation with Shadcn form components
- API URL is http://localhost:3001/api
- Token and user stored in localStorage after auth
- Use ApiError class for typed error handling in catch blocks
- AuthContext provides isLoading state for showing loading spinners during auth check
- Layout component wraps protected routes for consistent sidebar/header navigation
- Use cn() utility from lib/utils to merge Tailwind classes conditionally
- API routes: use `router.use(authMiddleware)` for protected routes, cast params with `as string`

---

## 2026-01-16 12:55 - US-020
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Products CRUD backend endpoints with pagination and stock adjustment
- Files changed:
  - apps/api/src/routes/products.ts (new - full CRUD for products with stock endpoint)
  - apps/api/src/index.ts (registered products routes)
- **Learnings for future iterations:**
  - Product model fields: name, price (required); description, laborCost, quantity, minStock, categoryId (optional)
  - GET /:id includes materials relation for technical sheet: `include: { materials: { include: { material: true } } }`
  - Stock uses Int type (not Float like materials) for whole unit quantities
  - Same pattern as materials routes: authMiddleware, pagination, ownership validation
---

## 2026-01-16 12:45 - US-019
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Material form page for creating and editing materials
- Files changed:
  - apps/web/src/pages/MaterialFormPage.tsx (new - form for create/edit materials with category dropdown)
  - apps/web/src/App.tsx (added routes for /materials/new and /materials/:id)
- **Learnings for future iterations:**
  - Use string type for numeric form fields to avoid z.coerce.number() typing issues with react-hook-form
  - Convert strings to numbers with parseFloat() in onSubmit before sending to API
  - Fetch categories with type filter: `/categories?type=MATERIAL`
  - Category dropdown uses Select component with disabled state while loading
  - Follow same pattern as ClientFormPage for form structure and validation
---

## 2026-01-16 12:30 - US-018
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Materials list page with low stock indicator
- Files changed:
  - apps/web/src/pages/MaterialsPage.tsx (new - materials list with table and low stock badges)
  - apps/web/src/App.tsx (updated route to use MaterialsPage)
- **Learnings for future iterations:**
  - Low stock indicator: check `quantity < minStock`, show amber badge with AlertTriangle icon
  - Use Intl.NumberFormat for currency: `new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })`
  - Include category relation from API for display: `material.category?.name || '-'`
  - Styling: amber colors for low stock (text-amber-600, bg-amber-50)
---

## 2026-01-16 12:25 - US-017
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Materials CRUD backend endpoints with pagination and stock adjustment
- Files changed:
  - apps/api/src/routes/materials.ts (new - full CRUD for materials with stock endpoint)
  - apps/api/src/index.ts (registered materials routes)
- **Learnings for future iterations:**
  - Material model fields: name, unit, unitPrice (required); description, quantity, minStock, supplier, categoryId (optional)
  - Include category relation in queries: `include: { category: true }`
  - Separate stock adjustment endpoint: PUT /api/materials/:id/stock
  - Validate categoryId belongs to user before creating/updating material
---

## 2026-01-16 12:20 - US-016
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Client form page for creating and editing clients
- Files changed:
  - apps/web/src/pages/ClientFormPage.tsx (new - form for create/edit clients)
  - apps/web/src/components/ui/sonner.tsx (new - toast notifications via sonner)
  - apps/web/src/components/ui/textarea.tsx (new - Shadcn textarea component)
  - apps/web/src/App.tsx (added routes for /clients/new and /clients/:id, Toaster)
  - apps/web/package.json (added sonner dependency)
- **Learnings for future iterations:**
  - Use sonner for toast notifications: `import { toast } from 'sonner'` then `toast.success('message')`
  - Add Toaster component to App.tsx for toasts to work
  - Use useParams hook to get route params for edit mode: `const { id } = useParams<{ id: string }>()`
  - Check `Boolean(id)` to determine if editing vs creating
  - Form reset with fetched data: `form.reset({ ...data })`
  - Textarea component from Shadcn for multi-line input (notes field)
---

## 2026-01-16 12:10 - US-015
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Clients list page with table, loading state, and actions
- Files changed:
  - apps/web/src/pages/ClientsPage.tsx (new - clients list with table)
  - apps/web/src/App.tsx (updated route to use ClientsPage)
- **Learnings for future iterations:**
  - Use Shadcn Table components: Table, TableHeader, TableBody, TableRow, TableHead, TableCell
  - Use lucide-react icons: Plus, Pencil, Trash2, Loader2 for action buttons
  - Loading state: return early with Loader2 spinner while fetching
  - Delete with confirm() dialog and deleting state per row
  - Link "asChild" prop on Button to create button-styled links
  - Use api.get/delete from lib/api for API calls with automatic token injection
---

## 2026-01-16 12:01 - US-014
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Clients CRUD backend endpoints with pagination
- Files changed:
  - apps/api/src/routes/clients.ts (new - full CRUD for clients with auth and pagination)
  - apps/api/src/index.ts (registered clients routes)
- **Learnings for future iterations:**
  - Pagination: use skip/take with page/limit query params, return total and totalPages
  - Client model fields: name (required), email, phone, address, notes (all optional)
  - All endpoints tested: GET list, GET/:id, POST, PUT/:id, DELETE/:id
  - Response format: { client } for single, { clients, pagination } for list
  - Use conditional spread operator for partial updates: ...(field !== undefined && { field })
---

## 2026-01-16 11:57 - US-013
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Categories CRUD backend endpoints
- Files changed:
  - apps/api/src/routes/categories.ts (new - full CRUD for categories with auth)
  - apps/api/src/index.ts (registered categories routes)
- **Learnings for future iterations:**
  - Route files apply authMiddleware to all routes via `router.use(authMiddleware)`
  - Use `req.params.id as string` to cast params to correct type for Prisma
  - Import CategoryType enum from @prisma/client for type validation
  - Categories have a `type` field with values PRODUCT or MATERIAL
  - findFirst with { id, userId } pattern checks both existence and ownership
---

## 2026-01-16 - US-012
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: App layout with sidebar navigation
- Files changed:
  - apps/web/src/components/Layout.tsx (new - main layout with sidebar and header)
  - apps/web/src/components/ui/sheet.tsx (new - Shadcn sheet component for mobile drawer)
  - apps/web/src/components/ui/separator.tsx (new - Shadcn separator component)
  - apps/web/src/components/ui/tooltip.tsx (new - Shadcn tooltip component)
  - apps/web/src/App.tsx (integrated Layout with protected routes)
  - apps/web/package.json (added @radix-ui/react-separator dependency)
- **Learnings for future iterations:**
  - Use Shadcn Sheet component for mobile sidebar drawer (slide in from left)
  - Layout uses fixed sidebar on desktop (md:w-64) with content offset (md:pl-64)
  - Mobile sidebar state managed with useState and Sheet open/onOpenChange
  - NavLink component uses useLocation() to determine active state
  - Active nav item uses bg-sidebar-accent and font-medium for visual distinction
  - Icons from lucide-react: LayoutDashboard, Users, Package, Boxes, FileText, Settings
---

## 2026-01-16 09:15 - US-011
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Auth context, API client, and protected routes
- Files changed:
  - apps/web/src/lib/api.ts (new - API client with automatic token injection)
  - apps/web/src/contexts/AuthContext.tsx (new - auth state management with user, login, logout, register)
  - apps/web/src/components/ProtectedRoute.tsx (new - redirects to /login if not authenticated)
  - apps/web/src/App.tsx (integrated AuthProvider and ProtectedRoute)
  - apps/web/src/pages/LoginPage.tsx (updated to use AuthContext)
  - apps/web/src/pages/RegisterPage.tsx (updated to use AuthContext)
- **Learnings for future iterations:**
  - API client auto-injects Bearer token from localStorage for all requests
  - AuthContext checks token validity on mount by calling /auth/me endpoint
  - ProtectedRoute shows loading spinner while auth state is being determined
  - LoginPage preserves original URL via location.state.from for redirect after login
  - Use ApiError class for typed error handling in catch blocks
---

## 2026-01-16 08:45 - US-010
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Login and registration pages with form validation
- Files changed:
  - apps/web/src/pages/LoginPage.tsx (new - login form with email/password)
  - apps/web/src/pages/RegisterPage.tsx (new - registration form with name/email/password/businessName)
  - apps/web/src/App.tsx (added /login and /register routes)
  - .claude/ralph/prd.json (marked US-005 through US-010 as passes: true)
- **Learnings for future iterations:**
  - Shadcn form components use react-hook-form Controller pattern via FormField
  - Use zodResolver from @hookform/resolvers for form schema validation
  - API returns { user, token } on successful auth
  - Store token in localStorage and redirect to / on success
  - Login page can display server errors via useState error state
---

## 2026-01-16 03:38 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Prisma ORM with complete database schema
- Files changed:
  - apps/api/package.json (added Prisma dependencies and db scripts)
  - apps/api/prisma/schema.prisma (complete schema with all models)
  - apps/api/prisma.config.ts (Prisma 7 config)
  - apps/api/.env (DATABASE_URL)
  - apps/api/.env.example (template for DATABASE_URL)
  - apps/api/.gitignore (exclude .env and generated Prisma)
- **Learnings for future iterations:**
  - Prisma 7 moved datasource URL from schema.prisma to prisma.config.ts
  - Docker Desktop on macOS can be unstable - be prepared for long image pulls
  - `prisma generate` works without database, `prisma migrate dev` requires running DB
  - Schema includes: User, Client, Category, Product, ProductMaterial, Material, Quote, QuoteItem
  - Enums: CategoryType (PRODUCT, MATERIAL), QuoteStatus (DRAFT, SENT, APPROVED, REJECTED, COMPLETED)
---
