# Ralph Progress Log
Started: Sex 16 Jan 2026 00:29:35 -03

## Codebase Patterns
- Prisma 7 requires DATABASE_URL in prisma.config.ts, NOT in schema.prisma
- Use `npm run db:migrate -w @artisan/api` to run migrations (requires Docker PostgreSQL running)
- Generated Prisma client goes to node_modules/@prisma/client
- API runs on port 3001, Web will run on port 5173
- Pages go in apps/web/src/pages/ directory
- Use react-hook-form + zod for form validation with Shadcn form components
- API URL is http://localhost:3001/api
- Token and user stored in localStorage after auth
- Use ApiError class for typed error handling in catch blocks
- AuthContext provides isLoading state for showing loading spinners during auth check
- Layout component wraps protected routes for consistent sidebar/header navigation
- Use cn() utility from lib/utils to merge Tailwind classes conditionally
- API routes: use `router.use(authMiddleware)` for protected routes, cast params with `as string`
- ProductMaterial composite key pattern: use `productId_materialId: { productId, materialId }` for findUnique/update/delete

---

## 2026-01-16 12:50 - US-023
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Verified: Technical sheet endpoints already implemented in apps/api/src/routes/products.ts
- All endpoints tested via curl and working correctly:
  - GET /api/products/:id/materials - returns product's materials with quantities
  - POST /api/products/:id/materials - adds material to product
  - PUT /api/products/:id/materials/:materialId - updates material quantity
  - DELETE /api/products/:id/materials/:materialId - removes material from product
  - GET /api/products/:id/cost - calculates total cost (materialCost + laborCost)
- **Learnings for future iterations:**
  - ProductMaterial has composite unique key: `@@unique([productId, materialId])`
  - Use `productId_materialId` object for Prisma composite key queries
  - Cost calculation: sum of (quantity Ã— unitPrice) for each material + laborCost
  - Material cost breakdown returned with individual material costs for UI display
  - Always validate both product ownership and material ownership before adding to technical sheet
---

## 2026-01-16 13:20 - US-022
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Product form page for creating and editing products
- Files changed:
  - apps/web/src/pages/ProductFormPage.tsx (new - form for create/edit products with category dropdown)
  - apps/web/src/App.tsx (added routes for /products/new and /products/:id)
- **Learnings for future iterations:**
  - Same pattern as MaterialFormPage for form pages
  - Use string type for numeric form fields to avoid z.coerce.number() typing issues with react-hook-form
  - Convert strings to numbers with parseFloat()/parseInt() in onSubmit before sending to API
  - Fetch categories with type filter: `/categories?type=PRODUCT`
  - Products use Int for quantity (not Float like materials) since they're whole units
  - Edit mode shows "Update Product" button, create mode shows "Create Product"
---

## 2026-01-16 13:05 - US-021
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Products list page with table and low stock indicator
- Files changed:
  - apps/web/src/pages/ProductsPage.tsx (new - products list with table, low stock badges, action buttons)
  - apps/web/src/App.tsx (updated route to use ProductsPage)
- **Learnings for future iterations:**
  - Same pattern as MaterialsPage for list pages
  - Action buttons include: Edit, Technical Sheet (link), Manufacture (disabled for now), Delete
  - Use lucide-react icons: FileText for technical sheet, Factory for manufacture
  - Manufacture button disabled until US-026 implements the dialog
  - Technical Sheet links to /products/:id/technical-sheet (placeholder for US-024)
---

## 2026-01-16 12:55 - US-020
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Products CRUD backend endpoints with pagination and stock adjustment
- Files changed:
  - apps/api/src/routes/products.ts (new - full CRUD for products with stock endpoint)
  - apps/api/src/index.ts (registered products routes)
- **Learnings for future iterations:**
  - Product model fields: name, price (required); description, laborCost, quantity, minStock, categoryId (optional)
  - GET /:id includes materials relation for technical sheet: `include: { materials: { include: { material: true } } }`
  - Stock uses Int type (not Float like materials) for whole unit quantities
  - Same pattern as materials routes: authMiddleware, pagination, ownership validation
---

## 2026-01-16 12:45 - US-019
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Material form page for creating and editing materials
- Files changed:
  - apps/web/src/pages/MaterialFormPage.tsx (new - form for create/edit materials with category dropdown)
  - apps/web/src/App.tsx (added routes for /materials/new and /materials/:id)
- **Learnings for future iterations:**
  - Use string type for numeric form fields to avoid z.coerce.number() typing issues with react-hook-form
  - Convert strings to numbers with parseFloat() in onSubmit before sending to API
  - Fetch categories with type filter: `/categories?type=MATERIAL`
  - Category dropdown uses Select component with disabled state while loading
  - Follow same pattern as ClientFormPage for form structure and validation
---

## 2026-01-16 12:30 - US-018
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Materials list page with low stock indicator
- Files changed:
  - apps/web/src/pages/MaterialsPage.tsx (new - materials list with table and low stock badges)
  - apps/web/src/App.tsx (updated route to use MaterialsPage)
- **Learnings for future iterations:**
  - Low stock indicator: check `quantity < minStock`, show amber badge with AlertTriangle icon
  - Use Intl.NumberFormat for currency: `new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' })`
  - Include category relation from API for display: `material.category?.name || '-'`
  - Styling: amber colors for low stock (text-amber-600, bg-amber-50)
---

## 2026-01-16 12:25 - US-017
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Materials CRUD backend endpoints with pagination and stock adjustment
- Files changed:
  - apps/api/src/routes/materials.ts (new - full CRUD for materials with stock endpoint)
  - apps/api/src/index.ts (registered materials routes)
- **Learnings for future iterations:**
  - Material model fields: name, unit, unitPrice (required); description, quantity, minStock, supplier, categoryId (optional)
  - Include category relation in queries: `include: { category: true }`
  - Separate stock adjustment endpoint: PUT /api/materials/:id/stock
  - Validate categoryId belongs to user before creating/updating material
---

## 2026-01-16 12:20 - US-016
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Client form page for creating and editing clients
- Files changed:
  - apps/web/src/pages/ClientFormPage.tsx (new - form for create/edit clients)
  - apps/web/src/components/ui/sonner.tsx (new - toast notifications via sonner)
  - apps/web/src/components/ui/textarea.tsx (new - Shadcn textarea component)
  - apps/web/src/App.tsx (added routes for /clients/new and /clients/:id, Toaster)
  - apps/web/package.json (added sonner dependency)
- **Learnings for future iterations:**
  - Use sonner for toast notifications: `import { toast } from 'sonner'` then `toast.success('message')`
  - Add Toaster component to App.tsx for toasts to work
  - Use useParams hook to get route params for edit mode: `const { id } = useParams<{ id: string }>()`
  - Check `Boolean(id)` to determine if editing vs creating
  - Form reset with fetched data: `form.reset({ ...data })`
  - Textarea component from Shadcn for multi-line input (notes field)
---

## 2026-01-16 12:10 - US-015
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Clients list page with table, loading state, and actions
- Files changed:
  - apps/web/src/pages/ClientsPage.tsx (new - clients list with table)
  - apps/web/src/App.tsx (updated route to use ClientsPage)
- **Learnings for future iterations:**
  - Use Shadcn Table components: Table, TableHeader, TableBody, TableRow, TableHead, TableCell
  - Use lucide-react icons: Plus, Pencil, Trash2, Loader2 for action buttons
  - Loading state: return early with Loader2 spinner while fetching
  - Delete with confirm() dialog and deleting state per row
  - Link "asChild" prop on Button to create button-styled links
  - Use api.get/delete from lib/api for API calls with automatic token injection
---

## 2026-01-16 12:01 - US-014
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Clients CRUD backend endpoints with pagination
- Files changed:
  - apps/api/src/routes/clients.ts (new - full CRUD for clients with auth and pagination)
  - apps/api/src/index.ts (registered clients routes)
- **Learnings for future iterations:**
  - Pagination: use skip/take with page/limit query params, return total and totalPages
  - Client model fields: name (required), email, phone, address, notes (all optional)
  - All endpoints tested: GET list, GET/:id, POST, PUT/:id, DELETE/:id
  - Response format: { client } for single, { clients, pagination } for list
  - Use conditional spread operator for partial updates: ...(field !== undefined && { field })
---

## 2026-01-16 11:57 - US-013
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Categories CRUD backend endpoints
- Files changed:
  - apps/api/src/routes/categories.ts (new - full CRUD for categories with auth)
  - apps/api/src/index.ts (registered categories routes)
- **Learnings for future iterations:**
  - Route files apply authMiddleware to all routes via `router.use(authMiddleware)`
  - Use `req.params.id as string` to cast params to correct type for Prisma
  - Import CategoryType enum from @prisma/client for type validation
  - Categories have a `type` field with values PRODUCT or MATERIAL
  - findFirst with { id, userId } pattern checks both existence and ownership
---

## 2026-01-16 - US-012
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: App layout with sidebar navigation
- Files changed:
  - apps/web/src/components/Layout.tsx (new - main layout with sidebar and header)
  - apps/web/src/components/ui/sheet.tsx (new - Shadcn sheet component for mobile drawer)
  - apps/web/src/components/ui/separator.tsx (new - Shadcn separator component)
  - apps/web/src/components/ui/tooltip.tsx (new - Shadcn tooltip component)
  - apps/web/src/App.tsx (integrated Layout with protected routes)
  - apps/web/package.json (added @radix-ui/react-separator dependency)
- **Learnings for future iterations:**
  - Use Shadcn Sheet component for mobile sidebar drawer (slide in from left)
  - Layout uses fixed sidebar on desktop (md:w-64) with content offset (md:pl-64)
  - Mobile sidebar state managed with useState and Sheet open/onOpenChange
  - NavLink component uses useLocation() to determine active state
  - Active nav item uses bg-sidebar-accent and font-medium for visual distinction
  - Icons from lucide-react: LayoutDashboard, Users, Package, Boxes, FileText, Settings
---

## 2026-01-16 09:15 - US-011
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Auth context, API client, and protected routes
- Files changed:
  - apps/web/src/lib/api.ts (new - API client with automatic token injection)
  - apps/web/src/contexts/AuthContext.tsx (new - auth state management with user, login, logout, register)
  - apps/web/src/components/ProtectedRoute.tsx (new - redirects to /login if not authenticated)
  - apps/web/src/App.tsx (integrated AuthProvider and ProtectedRoute)
  - apps/web/src/pages/LoginPage.tsx (updated to use AuthContext)
  - apps/web/src/pages/RegisterPage.tsx (updated to use AuthContext)
- **Learnings for future iterations:**
  - API client auto-injects Bearer token from localStorage for all requests
  - AuthContext checks token validity on mount by calling /auth/me endpoint
  - ProtectedRoute shows loading spinner while auth state is being determined
  - LoginPage preserves original URL via location.state.from for redirect after login
  - Use ApiError class for typed error handling in catch blocks
---

## 2026-01-16 08:45 - US-010
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Login and registration pages with form validation
- Files changed:
  - apps/web/src/pages/LoginPage.tsx (new - login form with email/password)
  - apps/web/src/pages/RegisterPage.tsx (new - registration form with name/email/password/businessName)
  - apps/web/src/App.tsx (added /login and /register routes)
  - .claude/ralph/prd.json (marked US-005 through US-010 as passes: true)
- **Learnings for future iterations:**
  - Shadcn form components use react-hook-form Controller pattern via FormField
  - Use zodResolver from @hookform/resolvers for form schema validation
  - API returns { user, token } on successful auth
  - Store token in localStorage and redirect to / on success
  - Login page can display server errors via useState error state
---

## 2026-01-16 03:38 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Prisma ORM with complete database schema
- Files changed:
  - apps/api/package.json (added Prisma dependencies and db scripts)
  - apps/api/prisma/schema.prisma (complete schema with all models)
  - apps/api/prisma.config.ts (Prisma 7 config)
  - apps/api/.env (DATABASE_URL)
  - apps/api/.env.example (template for DATABASE_URL)
  - apps/api/.gitignore (exclude .env and generated Prisma)
- **Learnings for future iterations:**
  - Prisma 7 moved datasource URL from schema.prisma to prisma.config.ts
  - Docker Desktop on macOS can be unstable - be prepared for long image pulls
  - `prisma generate` works without database, `prisma migrate dev` requires running DB
  - Schema includes: User, Client, Category, Product, ProductMaterial, Material, Quote, QuoteItem
  - Enums: CategoryType (PRODUCT, MATERIAL), QuoteStatus (DRAFT, SENT, APPROVED, REJECTED, COMPLETED)
---

## 2026-01-16 12:59 - US-024
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Technical sheet page for managing product materials
- Files changed:
  - apps/web/src/pages/TechnicalSheetPage.tsx (new - technical sheet page with materials table and cost summary)
  - apps/web/src/App.tsx (added route for /products/:id/technical-sheet)
- **Learnings for future iterations:**
  - Use SelectContent with SelectItem for material dropdown
  - Filter available materials to exclude those already added to the product
  - Use onBlur and onKeyDown (Enter) to trigger quantity updates inline
  - Cost breakdown from API includes materialBreakdown array for detailed display
  - TableFooter component for showing subtotals in table
  - Cost summary pattern: Material Cost + Labor Cost = Total Cost
  - Radix UI Select dropdowns may need special handling in automated browser tests
---

## 2026-01-16 13:10 - US-025
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Manufacture endpoint for producing products and consuming materials
- Files changed:
  - apps/api/src/routes/products.ts (added POST /:id/manufacture endpoint)
- **Learnings for future iterations:**
  - Use Prisma transaction ($transaction) for atomic operations that modify multiple tables
  - Use increment/decrement in Prisma update for atomic quantity changes
  - Structure error responses with detailed arrays (insufficientMaterials) for UI display
  - Structure warning responses similarly (lowStockWarnings) for alerts
  - Validate product has materials defined before allowing manufacture
  - Check both sufficient stock (error case) and low stock threshold (warning case)
  - Response includes: message, updated product, manufactured quantity, and optional warnings
---

## 2026-01-16 13:20 - US-026
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Manufacture dialog for products page
- Files changed:
  - apps/web/src/components/ManufactureDialog.tsx (new - dialog with stock validation, warnings, errors)
  - apps/web/src/pages/ProductsPage.tsx (integrated dialog, enabled manufacture button)
- **Learnings for future iterations:**
  - Use Dialog component from Shadcn for modal dialogs
  - Manage dialog state (open, productId) in parent component for better control
  - Client-side stock validation mirrors server-side for immediate UI feedback
  - Use useEffect with dependencies to trigger stock recalculation when quantity changes
  - Toast notifications with sonner: toast.success() for success, toast.warning() for warnings
  - Disabled state on button: `disabled={!canManufacture || loading}`
  - Color coding: red (bg-red-50/text-red-800) for errors, amber for warnings, green for OK
---

## 2026-01-16 13:26 - US-027
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Quotes CRUD backend endpoints with pagination, status filter, and auto-increment
- Files changed:
  - apps/api/src/routes/quotes.ts (new - full CRUD for quotes with items)
  - apps/api/src/index.ts (registered quotes routes)
- **Learnings for future iterations:**
  - Quote model has `@@unique([userId, number])` for per-user auto-increment
  - Use `findFirst` with `orderBy: { number: 'desc' }` to get last quote number for user
  - Quote totals: subtotal = sum of items, total = subtotal + laborCost - discount (or manualTotal if set)
  - Items are managed in transaction: delete all existing items then create new ones on update
  - Include `_count: { select: { items: true } }` in list queries for item count without full items
  - QuoteStatus enum from @prisma/client: DRAFT, SENT, APPROVED, REJECTED, COMPLETED
  - Validate all productIds belong to user before creating quote items
  - QuoteItem has optional productId for linking to products or manual entry
---

## 2026-01-16 13:35 - US-028
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Quotes list page with table, status badges, and filter
- Files changed:
  - apps/web/src/pages/QuotesPage.tsx (new - quotes list with table, status badges, filter dropdown)
  - apps/web/src/components/ui/badge.tsx (new - Shadcn badge component)
  - apps/web/src/App.tsx (updated route to use QuotesPage)
- **Learnings for future iterations:**
  - Use useSearchParams from react-router-dom for URL-based filtering state
  - Status badge colors: Draft=slate, Sent=blue, Approved=green, Rejected=red, Completed=purple
  - Badge component from Shadcn uses className for custom colors with `hover:bg-*` to maintain hover state
  - Select component with onValueChange updates URL params which triggers refetch via useEffect dependency
  - API quote list response includes `_count: { items: number }` for item count
  - Same list page pattern as ClientsPage with added filter functionality
---

## 2026-01-16 - US-029
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Quote form page with basic info fields
- Files changed:
  - apps/web/src/pages/QuoteFormPage.tsx (new - quote form with client, title, description, validUntil, notes)
  - apps/web/src/components/ui/calendar.tsx (new - Shadcn calendar component)
  - apps/web/src/components/ui/popover.tsx (new - Shadcn popover component)
  - apps/web/src/App.tsx (added routes for /quotes/new and /quotes/:id)
  - apps/web/package.json (added date-fns, react-day-picker dependencies)
- **Learnings for future iterations:**
  - Date picker uses Shadcn Calendar + Popover components with date-fns for formatting
  - Use `disabled={(date) => date < new Date(new Date().setHours(0, 0, 0, 0))}` to disable past dates
  - Client dropdown fetches with high limit (?limit=1000) to get all clients for selection
  - Form uses separate loading state for clients fetch vs quote fetch in edit mode
  - Placeholder item `{ description: 'Item placeholder', quantity: 1, unitPrice: 0 }` needed for create since API requires at least one item
  - Edit mode (isEditing) determined by presence of id from useParams
  - validUntil stored as Date in form, converted to ISO string for API
---

## 2026-01-16 10:55 - US-030
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- Implemented: Quote items section with product selector and manual entry
- Files changed:
  - apps/web/src/pages/QuoteFormPage.tsx (updated - added items section with table, product dialog, manual entry)
- **Learnings for future iterations:**
  - Use Dialog component from Shadcn for product selector modal
  - Items state managed separately from form state using useState
  - Calculate item total on quantity/unitPrice change: `item.total = item.quantity * item.unitPrice`
  - Use TableFooter for subtotal row in items table
  - Product dialog shows list of clickable product buttons that auto-fill description/price
  - Form restructured to multiple Card sections: Quote Info, Items, Additional Info
  - Items validation happens in onSubmit before API call
  - When loading existing quote in edit mode, populate items state from API response
---
