# Ralph Progress Log - Artisan App
# Branch: ralph/artisan-management-app
# Started: 2026-01-16
# =========================================

## Codebase Patterns
- Package naming: @artisan/api, @artisan/web, @artisan/shared
- Root dev script uses concurrently to run api and web together
- TypeScript is used across all packages
- API runs on port 3001, Web runs on port 5173
- PostgreSQL runs on port 5433 (Docker) to avoid local PostgreSQL conflicts
- Prisma 7: Use `env("DATABASE_URL")` in prisma.config.ts, NOT `process.env` or schema.prisma url
- Prisma 7 Runtime: MUST use @prisma/adapter-pg with PrismaPg adapter for PrismaClient initialization
- TailwindCSS v4 uses CSS-based config (no tailwind.config.js), import via `@import "tailwindcss"` in CSS
- Shadcn/ui: Uses @/* path alias, components at src/components/ui/, utils at src/lib/utils.ts
- Auth: JWT_SECRET from env or default, bcrypt with 10 salt rounds, 7d token expiry
- Auth middleware: Use AuthenticatedRequest interface to extend Express Request with userId property
---

## 2026-01-16 - US-001
- What was implemented: Monorepo structure with npm workspaces
- Files changed:
  - package.json (root with workspaces config)
  - apps/api/package.json, tsconfig.json, src/index.ts
  - apps/web/package.json, tsconfig.json, src/index.ts
  - packages/shared/package.json, tsconfig.json, src/index.ts
  - .gitignore
- **Learnings for future iterations:**
  - Workspace packages reference each other via "*" in dependencies (e.g., "@artisan/shared": "*")
  - API package needs @types/node for console.log to typecheck
  - Root typecheck runs all workspace typechecks with `npm run typecheck --workspaces --if-present`
---

## 2026-01-16 - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Docker Compose configuration for PostgreSQL 15
- Files changed:
  - docker-compose.yml (new file at root)
- **Learnings for future iterations:**
  - Docker Compose uses named volume `postgres_data` for data persistence
  - Database credentials: artisan_db / artisan / artisan123
  - Includes healthcheck for reliable startup detection
  - Container name: artisan_postgres
---

## 2026-01-16 - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Express server with TypeScript and hot reload
- Files changed:
  - apps/api/package.json (added express, cors, ts-node-dev dependencies)
  - apps/api/src/index.ts (Express server with CORS and health endpoint)
- **Learnings for future iterations:**
  - Express 5.x is the current version (installed 5.2.1)
  - ts-node-dev with --respawn --transpile-only provides fast hot reload
  - CORS configured to allow requests from localhost:5173 (frontend)
  - Health check endpoint at GET /api/health returns { status: 'ok' }
  - Use underscore prefix for unused params (_req) to avoid TypeScript errors
---

## 2026-01-16 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Prisma ORM with complete database schema and migrations
- Files changed:
  - apps/api/prisma/schema.prisma (complete schema with all models and relations)
  - apps/api/prisma.config.ts (fixed to use env() helper for DATABASE_URL)
  - apps/api/prisma/migrations/20260116111156_init/migration.sql (initial migration)
  - apps/api/.env.example (updated with port 5433 documentation)
  - docker-compose.yml (changed port to 5433 to avoid local PostgreSQL conflict)
- **Learnings for future iterations:**
  - Prisma 7 requires prisma.config.ts for database URL configuration
  - Use `env("DATABASE_URL")` from `prisma/config` instead of `process.env`
  - The `url` property is no longer supported in schema.prisma datasource block
  - Docker port 5433 is used externally to avoid conflicts with local PostgreSQL on port 5432
  - Run `npm run db:generate` then `npm run db:migrate -- --name init` to create migrations
  - Generated Prisma client goes to node_modules/@prisma/client
---

## 2026-01-16 - US-005
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Frontend with Vite, React 18, and TypeScript
- Files changed:
  - apps/web/package.json (replaced placeholder with Vite/React config)
  - apps/web/tsconfig.json (configured for React/Vite bundler mode)
  - apps/web/vite.config.ts (Vite config with React plugin, port 5173)
  - apps/web/index.html (Vite entry HTML)
  - apps/web/src/main.tsx (React root with StrictMode)
  - apps/web/src/App.tsx (BrowserRouter with basic Dashboard route)
  - apps/web/src/index.css (basic styling)
  - apps/web/src/vite-env.d.ts (Vite type definitions)
  - apps/web/public/vite.svg (favicon)
  - .gitignore (added *.tsbuildinfo)
- **Learnings for future iterations:**
  - Vite 6.x is the current version for React projects
  - React Router v6 uses BrowserRouter, Routes, and Route components
  - tsconfig uses `"jsx": "react-jsx"` for React 18
  - Vite config uses `@vitejs/plugin-react` for React support
  - Frontend dev server runs on port 5173 by default (configured in vite.config.ts)
  - Use `tsc -b --noEmit` for typecheck in Vite projects (uses project references)
---

## 2026-01-16 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: TailwindCSS v4 and Shadcn/ui configuration
- Files changed:
  - apps/web/package.json (added tailwindcss, @tailwindcss/vite, and shadcn dependencies)
  - apps/web/vite.config.ts (added tailwindcss plugin and @/* path alias)
  - apps/web/tsconfig.json (added baseUrl and paths for @/* alias)
  - apps/web/src/index.css (TailwindCSS v4 directives and CSS variables for themes)
  - apps/web/components.json (Shadcn/ui configuration)
  - apps/web/src/lib/utils.ts (cn utility for class merging)
  - apps/web/src/components/ui/button.tsx (Shadcn Button component)
  - apps/web/src/components/ui/input.tsx (Shadcn Input component)
  - apps/web/src/components/ui/card.tsx (Shadcn Card component)
  - apps/web/src/components/ui/dialog.tsx (Shadcn Dialog component)
  - apps/web/src/components/ui/table.tsx (Shadcn Table component)
  - apps/web/src/components/ui/select.tsx (Shadcn Select component)
  - apps/web/src/components/ui/form.tsx (Shadcn Form component)
  - apps/web/src/components/ui/label.tsx (Shadcn Label component)
  - apps/web/src/App.tsx (updated with sample Shadcn components for verification)
- **Learnings for future iterations:**
  - TailwindCSS v4 is CSS-first configuration (no tailwind.config.js needed)
  - Use `@import "tailwindcss"` instead of `@tailwind base/components/utilities` directives
  - Shadcn/ui requires path alias (@/*) configured in both tsconfig.json and vite.config.ts
  - Use `npx shadcn@latest init -d` for default configuration
  - Add components with `npx shadcn@latest add button input card dialog table select form -y`
  - Theme variables are defined in CSS using oklch color space (CSS Color Level 4)
  - Light/dark theme support via CSS custom properties and `.dark` class
---

## 2026-01-16 - US-007
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: User registration endpoint with validation and JWT
- Files changed:
  - apps/api/package.json (added bcrypt, jsonwebtoken, @prisma/adapter-pg dependencies)
  - apps/api/src/index.ts (added auth routes)
  - apps/api/src/routes/auth.ts (POST /api/auth/register endpoint)
  - apps/api/src/lib/prisma.ts (centralized Prisma client with PG adapter)
- **Learnings for future iterations:**
  - Prisma 7 requires @prisma/adapter-pg with PrismaPg for runtime database connections
  - PrismaClient must be initialized with: `new PrismaClient({ adapter: new PrismaPg({ connectionString }) })`
  - Import dotenv/config at the top of lib/prisma.ts to load environment variables
  - bcrypt.hash() with 10 salt rounds for password hashing
  - jwt.sign() with { expiresIn: '7d' } for 7-day token expiry
  - Use destructuring to exclude password: `const { password: _, ...userWithoutPassword } = user`
  - Email validation regex: `/^[^\s@]+@[^\s@]+\.[^\s@]+$/`
---

## 2026-01-16 - US-008
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Login endpoint with password verification
- Files changed:
  - apps/api/src/routes/auth.ts (added POST /api/auth/login endpoint)
- **Learnings for future iterations:**
  - Use bcrypt.compare(plainPassword, hashedPassword) to verify passwords
  - Return generic "Invalid credentials" message for both wrong email and wrong password (security)
  - jwt.sign() with { expiresIn: '7d' } creates a token that expires in 7 days
---

## 2026-01-16 - US-009
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Auth middleware and profile endpoints
- Files changed:
  - apps/api/src/middleware/auth.ts (new file - auth middleware)
  - apps/api/src/routes/auth.ts (added GET /api/auth/me and PUT /api/auth/profile endpoints)
- **Learnings for future iterations:**
  - Auth middleware extends Express Request with AuthenticatedRequest interface
  - JWT token is extracted from "Bearer <token>" format in Authorization header
  - Use jwt.verify() to decode and validate token, catching JsonWebTokenError and TokenExpiredError
  - Middleware adds userId to request object for use in protected route handlers
  - Profile update endpoint allows partial updates using undefined checks
---

## 2026-01-16 - US-010
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Login and registration pages with form validation
- Files verified (already existed from previous iteration):
  - apps/web/src/pages/LoginPage.tsx (/login page with email and password fields)
  - apps/web/src/pages/RegisterPage.tsx (/register page with name, email, password, businessName fields)
  - apps/web/src/contexts/AuthContext.tsx (auth state management)
  - apps/web/src/lib/api.ts (API client with automatic token injection)
  - apps/web/src/components/ProtectedRoute.tsx (route protection)
  - apps/web/src/App.tsx (routes configuration)
- **Learnings for future iterations:**
  - Forms use react-hook-form with zod resolver for validation
  - Shadcn Form component integrates with react-hook-form using FormField, FormControl, FormItem
  - Login page preserves intended destination via location.state.from for redirect after auth
  - API errors are handled via ApiError class with status code and message
  - Both pages show error messages from API responses in a styled error box
  - Token and user data stored in localStorage, validated on app init via /auth/me endpoint
---

## 2026-01-16 - US-011
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Auth context, protected routes, and API client (already existed from previous iteration)
- Files verified:
  - apps/web/src/contexts/AuthContext.tsx (AuthContext with user state, login, logout, register functions)
  - apps/web/src/components/ProtectedRoute.tsx (redirects to /login if not authenticated)
  - apps/web/src/lib/api.ts (API client with automatic token injection)
- **Learnings for future iterations:**
  - AuthContext uses useEffect to check token validity on init via /auth/me endpoint
  - isLoading state prevents flash of login page while checking auth status
  - ProtectedRoute shows spinner while isLoading is true
  - API client uses class pattern with private getToken() method for automatic token injection
---

## 2026-01-16 - US-012
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: App layout with sidebar navigation (already existed from previous iteration)
- Files verified:
  - apps/web/src/components/Layout.tsx (Layout component with sidebar navigation)
- **Learnings for future iterations:**
  - Uses Shadcn Sheet component for mobile sidebar (slides in from left)
  - NavItems defined as array of { title, href, icon } for easy maintenance
  - Active nav item detection uses pathname matching with startsWith for nested routes
  - Desktop sidebar is fixed position (md:fixed md:inset-y-0), main content has md:pl-64 offset
  - Mobile hamburger menu uses SheetTrigger inside header
  - User name displayed in header with hidden sm:inline for mobile responsiveness
  - lucide-react icons used: LayoutDashboard, Users, Package, Boxes, FileText, Settings, Menu, LogOut
---

## 2026-01-16 - US-013 to US-022 (Batch Verification)
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was verified: Multiple backend and frontend features (all already implemented in previous iterations)
- US-013: Categories CRUD endpoints - apps/api/src/routes/categories.ts
- US-014: Clients CRUD endpoints - apps/api/src/routes/clients.ts
- US-015: Clients list page - apps/web/src/pages/ClientsPage.tsx
- US-016: Client form page - apps/web/src/pages/ClientFormPage.tsx
- US-017: Materials CRUD endpoints - apps/api/src/routes/materials.ts
- US-018: Materials list page - apps/web/src/pages/MaterialsPage.tsx
- US-019: Material form page - apps/web/src/pages/MaterialFormPage.tsx
- US-020: Products CRUD endpoints - apps/api/src/routes/products.ts
- US-021: Products list page - apps/web/src/pages/ProductsPage.tsx
- US-022: Product form page - apps/web/src/pages/ProductFormPage.tsx
- **Learnings for future iterations:**
  - All CRUD endpoints follow same pattern: router.use(authMiddleware), then GET /, GET /:id, POST /, PUT /:id, DELETE /:id
  - Pagination pattern: page/limit query params, returns { items, pagination: { page, limit, total, totalPages } }
  - Form pages use react-hook-form with zod resolver, same pattern as Login/Register
  - List pages use loading/error states with Loader2 spinner and retry button
  - Low stock indicator: isLowStock(item) checks item.quantity < item.minStock
  - Currency formatting uses Intl.NumberFormat with pt-BR locale and BRL currency
  - Category dropdowns filter by type (MATERIAL or PRODUCT) when fetching
  - Toast notifications use sonner library via toast.success()
---

## 2026-01-16 - US-023
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented: Technical sheet endpoints for managing product materials
- Files changed:
  - apps/api/src/routes/products.ts (added 5 new endpoints for technical sheet)
- New endpoints:
  - GET /api/products/:id/materials - list product materials with quantities
  - POST /api/products/:id/materials - add material to product
  - PUT /api/products/:id/materials/:materialId - update material quantity
  - DELETE /api/products/:id/materials/:materialId - remove material from product
  - GET /api/products/:id/cost - calculate total cost (materialCost + laborCost)
- **Learnings for future iterations:**
  - Use Prisma's unique compound key syntax: `where: { productId_materialId: { productId, materialId } }`
  - Cost calculation returns materialBreakdown array with individual material costs
  - All endpoints verify product belongs to user via userId filter
  - POST checks if material already exists in product to prevent duplicates
  - Material validation ensures materialId belongs to the same user
---

